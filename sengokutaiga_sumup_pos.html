<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>戦国大河座標まとめ</title>
</head>
<body>
	<h1>戦国大河座標まとめ</h1>
	<div>
		形式：<input type="text" id="fmt" size="40" value="$N.R$R:$X,$Y">（$N=連番、$R=ランク、$X=X座標、$Y=Y座標）<br />
		開始番号：<input type="text" id="startno" size="10" value="1"><br />
		改行頻度：<input type="text" id="nl" size="10" value="2"><br />
		重複チェック：<input type="checkbox" id="chkdup" checked><br />
		<strong>Input: チャットからコピー</strong><br />
		<textarea id="input_text" rows="15" cols="100"></textarea><br />
		<input type="button" id="trans" value="↓変換する"><br />
		<strong>Output</strong><br />
		<textarea id="output_text" rows="15" cols="100"></textarea><br />
	</div>

<script>
document.getElementById("trans").onclick = function(){
	const fmt = document.getElementById("fmt").value;
	const startno = parseInt(document.getElementById("startno").value,10);
	const nl = parseInt(document.getElementById("nl").value,10);
	const chkdup = document.getElementById("chkdup").checked;
	const text = document.getElementById("input_text").value;

	const re = /ランク:(\d) *座標:\(?\s*([-\d]+),([-\d]+)/g;

	if ( nl <= 0) {
		nl = 1;
	} 

	let m;
	let new_text = "";
	let pos_dupchk = {};
	let i = 0;

	while ((m = re.exec(text)) !== null) {
		const no = startno + i;
		const r = m[1];
		const x = m[2];
		const y = m[3];
		const sep = ((i%nl) == (nl-1)) ? "\n" : "　";

		if ( chkdup && pos_dupchk[x+","+y] ) {
			x += "(重複)";
			y += "(重複)";
		}

		new_text += fmt
		  .replace('$N',no)
		  .replace('$R',r)
		  .replace('$X',x)
		  .replace('$Y',y)
		  +sep;
		
		pos_dupchk[x+","+y] = 1;
		i++;
	}
	document.getElementById("output_text").value = new_text;
}
</script>

</body>
</html>
